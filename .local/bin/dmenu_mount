#!/bin/sh
# Program:
# *   Gives a dmenu prompt to mount unmounted drives. If
#     they're in /etc/fstab, they'll be mounted automatically. Otherwise,
#     you'll be prompted to give a mountpoint from already existsing
#     directories. If you input a novel directory, it will prompt you to
#     create that directory.
# Dependency:
# *   dmenu(1)
# *   mount.exfat-fuse(1)
# *   prompt.sh
# Author:
# *   Chang, Chu-Kuan <cckuan@changchukuan.name>

#
# Proper
#

# shellcheck source=/dev/null
. prompt.sh

readonly progname="$(basename "$0")"

lsdisk()
{
	disks="$(
		sysctl -n hw.disknames \
		    | tr ',' '\n' \
		    | cut -d ':' -f 1
	)"

	# 'or' collection of mounted partitions
	already_mounted_disks_regex="$(
		mount | cut -d ' ' -f 1 | paste -sd '|' -
	)"

	for disk in ${disks}; do
		doas -n disklabel -h "${disk}" 2>/dev/null \
		| awk -v disk="${disk}" '
			/^label: / {
				sub("^label: ", "", $0);
				sub("[[:blank:]]*$", "", $0);
				label = $0;
			}

			/^total sectors: / {
				total_bytes = $NF;
			}

			/^[[:blank:]]+[[:alpha:]]:/ {
				if ($1 == "c:" || $4 == "swap" || $4 == "RAID") {
					next;
				}
				printf("/dev/%s%c %10s %10s (%s, total bytes: %s)\n",
				    disk, $1, $2, $4, label, total_bytes);
			}
		' \
		| grep -vE "${already_mounted_disks_regex}"
	done
}

get_mount_point() {
	already_mounted="$(
		mount \
		    | awk '/.*\/mnt.*/ { printf("-not ( -path %s -prune ) ", $3) }'
	)"

	# shellcheck disable=SC2086
	find /mnt -type d -maxdepth 3 ${already_mounted} -print 2>/dev/null \
	    | dmenu -l 15 -p 'Type in mount point:'
}

mountdisk() {
	chosen="$(
		printf '%s' "$1" \
		    | dmenu -l 15 -p 'Mount which drive?' \
		    | tr -s ' '
	)"
	[ -z "${chosen}" ] && exit 1

	chosen_disk="$(   printf '%s' "${chosen}"   | cut -d ' ' -f 1)"
	chosen_size="$(   printf '%s' "${chosen}"   | cut -d ' ' -f 2)"
	chosen_fstype="$( printf '%s' "${chosen}"   | cut -d ' ' -f 3)"

	if [ "${chosen_fstype}" = 'NTFS' ]; then
		chosen_fstype="$(
			printf 'exFAT\nNTFS' \
			    | dmenu -l 15 -p 'Which File system?' \
		)"
	fi

	if [ -z "${chosen_disk}" ] \
	    || [ -z "${chosen_size}" ] \
	    || [ -z "${chosen_fstype}" ]; then
		exit 1
	fi

	mount_point="$(get_mount_point)"

	if [ ! -d "${mount_point}" ]; then
		notify "${mount_point} does not exist."
		exit 1
	fi

	prompt -x "Mount ${chosen_disk} (${chosen_fstype}, ${chosen_size}) to ${mount_point}?" \
	    || exit 1

	doas -n mount "${chosen_disk}" 2>/dev/null \
	    && notify "${chosen_disk} mounted." \
	    && exit 0

	case "${chosen_fstype}" in
	'4.2BSD')
		doas -n mount_ffs "${chosen_disk}" "${mount_point}"
		;;
	'cd9660')
		doas -n mount_cd9660 "${chosen_disk}" "${mount_point}"
		;;
	'exFAT')
		doas -n mount.exfat-fuse -o "gid=$(id -g),uid=$(id -u)" \
		    "${chosen_disk}" "${mount_point}"
		chosen_disk='fusefs'
		;;
	'MSDOS')
		doas -n mount_msdos -g "$(id -g)" -u "$(id -u)" \
		    "${chosen_disk}" "${mount_point}"
		;;
	'NTFS')
		doas -n mount_ntfs -g "$(id -g)" -u "$(id -u)" \
		    "${chosen_disk}" "${mount_point}"
		;;
	*)
		notify 'Unknown filesystem.'
		exit 1
		;;
	esac

	if mount | grep -q "${chosen_disk}.*${mount_point}"; then
		notify "${chosen_disk} mounted to ${mount_point}."
	else
		notify "Failed mounting ${chosen_disk} to ${mount_point}."
	fi
}

notify()
{
	notify-send --urgency=normal --icon=drive-harddisk-usb \
	    --hint="string:synchronous:${progname}" "${progname}" \
	    "$@"
}

readonly disk_info="$(lsdisk)"

if [ -z "${disk_info}" ]; then
	notify 'No mountable disk detected.'
	exit 0
else
	notify 'Mountable disks detected.'
	mountdisk "${disk_info}"
fi

